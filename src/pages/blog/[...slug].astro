---
import { getCollection, getEntry } from 'astro:content';

import type { GetStaticPaths } from 'astro';

import DefaultLayout from '@/layouts/default/index.astro';

import BlogHeader from '@/components/astro/blog/blog-header/index.astro';
import TocAsideNav from '@/components/astro/blog/toc-aside-nav/index.astro';
import SeoMeta from '@/components/astro/seo-meta/index.astro';
import { BlogBackAction } from '@/components/react/blog/back-action';
import { components } from '@/components/react/blog/content-blocks';

export const getStaticPaths = (async () => {
	const allBlogs = await getCollection('blog');

	return allBlogs.map((blog) => ({
		params: {
			slug: blog.slug
		}
	}));
}) satisfies GetStaticPaths;

const { slug } = Astro.params;

const blog = await getEntry('blog', slug);

const {
	data: { seoMetaData, title, publishedDate },
	collection,
	render
} = blog;

const { Content, headings } = await render();
const showToc = headings.length > 0;
---

<DefaultLayout>
	<SeoMeta slot="head" {...seoMetaData} path={`/${collection}/${slug}`} />
	<main class="relative">
		<div class="gap-10 xl:grid xl:grid-cols-[var(--primary-content-width)_1fr]">
			<article class="xl:max-w-unset w-full max-w-[var(--primary-content-width)]">
				<!-- Back Action -->
				<BlogBackAction href={`/${collection}`} title="Go back to blogs page">go to blog</BlogBackAction>
				<!-- Blog Header -->
				<BlogHeader title={title} publishedDate={publishedDate} views={0} />

				<!-- Blog Content -->
				<Content components={components} />
			</article>

			{
				showToc && (
					<aside class="hidden xl:block">
						<div class="sticky top-[var(--page-blur-segment-height)] w-[var(--aside-toc-content)]">
							<h4 class="text-md mb-4">On this page</h4>
							<TocAsideNav tocContents={headings} />
						</div>
					</aside>
				)
			}
		</div>
	</main>

	<style>
		:root {
			--aside-toc-size: 25ch;
			--aside-nav-space-left: 0.8em;
		}

		@screen xl {
			:root {
				--page-content-width: 62.8rem;
			}
		}
	</style>
</DefaultLayout>
